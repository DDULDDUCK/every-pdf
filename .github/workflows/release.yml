# .github/workflows/release.yml

name: Build & Release Every-PDF

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    # ì´ì œ OSì™€ ì•„í‚¤í…ì²˜ ì¡°í•©ìœ¼ë¡œ ì‘ì—…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # ë¹Œë“œí•  OSì™€ ì•„í‚¤í…ì²˜ ì¡°í•©ì„ ì •ì˜í•©ë‹ˆë‹¤.
        include:
          - os: windows-latest
            arch: x64
          - os: macos-13 # Intel(x64) ë¹Œë“œë¥¼ ìœ„í•´ macos-13 ì‚¬ìš©
            arch: x64
          - os: macos-latest # Apple Silicon(arm64) ë¹Œë“œë¥¼ ìœ„í•´ macos-latest(ë˜ëŠ” macos-14) ì‚¬ìš©
            arch: arm64

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Python í™˜ê²½ ì„¤ì •
      - name: Setup Python and Cache Pip
        uses: actions/setup-python@v5
        with:
          python-version: '3.13' # ì•ˆì •ì ì¸ ë²„ì „ ì‚¬ìš© ê¶Œì¥
          cache: 'pip'

      # 3. Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js and Cache NPM
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 4. NPM ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci

      # 5. í”Œë«í¼ ë° ì•„í‚¤í…ì²˜ì— ë§ëŠ” ë¹Œë“œ ë° í¼ë¸”ë¦¬ì‹œ ì‹¤í–‰
      - name: Build and Release for Windows
        if: matrix.os == 'windows-latest'
        run: npm run publish -- --${{ matrix.arch }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and Release for macOS
        if: startsWith(matrix.os, 'macos')
        run: |
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤. (ë§¤ìš° ì¤‘ìš”)
          set -e

          echo "ğŸ” 1. API Key íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤."
          # APPLE_API_KEY Secretì„ ë””ì½”ë”©í•˜ì—¬ ì„ì‹œ .p8 íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
          # macOSì—ì„œëŠ” --decode ëŒ€ì‹  -D ì˜µì…˜ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
          echo -n "${{ secrets.APPLE_API_KEY }}" | base64 -D -o AuthKey.p8
          echo "âœ… API Key íŒŒì¼ ìƒì„± ì™„ë£Œ."

          echo "ğŸ” 2. í‚¤ì²´ì¸ì— ìê²© ì¦ëª…ì„ ì €ì¥í•©ë‹ˆë‹¤."
          # "NOTARY_PROFILE" ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ í”„ë¡œíŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
          # xcrunì´ ì„±ê³µí•˜ë©´ 'Success.' ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
          xcrun notarytool store-credentials "NOTARY_PROFILE" --key AuthKey.p8 --key-id "${{ secrets.APPLE_API_KEY_ID }}" --issuer "${{ secrets.APPLE_API_ISSUER }}"
          echo "âœ… í‚¤ì²´ì¸ í”„ë¡œíŒŒì¼ ìƒì„± ì™„ë£Œ."

          echo "ğŸ“¦ 3. Electron-Builderë¥¼ ì‹¤í–‰í•˜ì—¬ ì•±ì„ ë¹Œë“œí•˜ê³  í¼ë¸”ë¦¬ì‹œí•©ë‹ˆë‹¤."
          npm run publish -- --${{ matrix.arch }}
          echo "ğŸš€ ë¹Œë“œ ë° í¼ë¸”ë¦¬ì‹œ ì„±ê³µ!"
        env:
          # ë¦´ë¦¬ì¦ˆ ì—…ë¡œë“œìš©
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # ì½”ë“œ ì„œëª…ìš©
          CSC_LINK: ${{ secrets.MACOS_CERTIFICATE }}
          CSC_KEY_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          
          # ê³µì¦ìš© (í‚¤ì²´ì¸ í”„ë¡œíŒŒì¼ ì‚¬ìš©)
          # electron-builderì—ê²Œ ì‚¬ìš©í•  í‚¤ì²´ì¸ í”„ë¡œíŒŒì¼ ì´ë¦„ì„ ì•Œë ¤ì¤ë‹ˆë‹¤.
          APPLE_KEYCHAIN_PROFILE: "NOTARY_PROFILE"