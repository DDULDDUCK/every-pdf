# .github/workflows/release.yml

name: Build & Release Every-PDF (Sequential)

on:
  push:
    tags:
      - 'v*'

jobs:
  # =======================================================
  # JOB 1: macOS 빌드 및 게시
  # =======================================================
  build-and-publish-mac:
    runs-on: macos-latest
    permissions:
      contents: write # 릴리즈 생성 및 업로드 권한

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python and Cache Pip
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Setup Node.js and Cache NPM
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # 이 작업이 먼저 실행되어 GitHub Release를 생성합니다.
      - name: Build and Publish for macOS
        run: npm run build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =======================================================
  # JOB 2: Windows 빌드 및 게시 (macOS 작업이 끝난 후 실행)
  # =======================================================
  build-and-publish-windows:
    # 'needs' 키워드를 사용하여 순서를 강제합니다.
    needs: build-and-publish-mac
    runs-on: windows-latest
    permissions:
      contents: write # 기존 릴리즈에 파일 추가 권한

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python and Cache Pip
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Setup Node.js and Cache NPM
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # 이 작업은 이미 생성된 릴리즈에 파일을 추가합니다.
      - name: Build and Publish for Windows
        run: npm run build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}